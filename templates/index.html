{% extends "base.html" %}

{% block title %}é¦–é¡µ - å® ç‰©ä¸¢å¤±ç½‘ç«™{% endblock %}

{% block content %}
<!-- æ¬¢è¿æ¨ªå¹… -->
<div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 2rem;">
    <div class="card-body" style="text-align: center; padding: 3rem 2rem;">
        <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">ğŸ¾ å® ç‰©ä¸¢å¤±ç½‘ç«™</h1>
        <p style="font-size: 1.2rem; margin-bottom: 2rem; opacity: 0.9;">å¸®åŠ©æ¯ä¸€ä¸ªèµ°å¤±çš„å°ç”Ÿå‘½å›å®¶</p>
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('create_post') }}" class="btn btn-success" style="font-size: 1.1rem; padding: 0.8rem 2rem;">
                ğŸ“ å‘å¸ƒå¯»å® ä¿¡æ¯
            </a>
        {% else %}
            <div>
                <a href="{{ url_for('register') }}" class="btn btn-success" style="margin-right: 1rem;">ç«‹å³æ³¨å†Œ</a>
                <a href="{{ url_for('login') }}" class="btn" style="background-color: rgba(255,255,255,0.2); color: white;">ç”¨æˆ·ç™»å½•</a>
            </div>
        {% endif %}
    </div>
</div>

<!-- æœç´¢æ  -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-body">
        <div style="display: flex; gap: 1rem; align-items: center;">
            <input type="text" id="search-input" class="form-control" 
                   placeholder="ğŸ” æœç´¢å® ç‰©ç±»å‹ã€ä¸¢å¤±åœ°ç‚¹æˆ–æè¿°å…³é”®è¯..." 
                   style="flex: 1;">
            <select id="pet-type-filter" class="form-control" style="width: 150px;">
                <option value="">æ‰€æœ‰ç±»å‹</option>
                <option value="ç‹—">ç‹—ç‹—</option>
                <option value="çŒ«">çŒ«å’ª</option>
                <option value="é¸Ÿ">é¸Ÿç±»</option>
                <option value="å…”å­">å…”å­</option>
                <option value="ä»“é¼ ">ä»“é¼ </option>
                <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
    <div class="card" style="text-align: center; background-color: #e8f5e8;">
        <div class="card-body">
            <h3 style="color: #27ae60; margin-bottom: 0.5rem;">{{ posts|length }}</h3>
            <p style="margin: 0; color: #555;">å¯»å® ä¿¡æ¯</p>
        </div>
    </div>
    <div class="card" style="text-align: center; background-color: #e3f2fd;">
        <div class="card-body">
            <h3 style="color: #3498db; margin-bottom: 0.5rem;">{% set total_comments = 0 %}{% for post in posts %}{% set total_comments = total_comments + post.comments|length %}{% endfor %}{{ total_comments }}</h3>
            <p style="margin: 0; color: #555;">çƒ­å¿ƒè¯„è®º</p>
        </div>
    </div>
    <div class="card" style="text-align: center; background-color: #fff3e0;">
        <div class="card-body">
            <h3 style="color: #f39c12; margin-bottom: 0.5rem;">24/7</h3>
            <p style="margin: 0; color: #555;">å…¨å¤©å€™æœåŠ¡</p>
        </div>
    </div>
</div>

<!-- å¸–å­åˆ—è¡¨ -->
{% if posts %}
    <div class="post-grid" id="posts-container">
        {% for post in posts %}
        <div class="post-card" data-pet-type="{{ post.pet_type }}">
            <!-- å›¾ç‰‡åŒºåŸŸ -->
            <div class="post-images">
                {% if post.images %}
                    <img src="{{ url_for('static', filename='uploads/' + post.images[0].filename) }}" 
                         alt="{{ post.title }}" onclick="openImageModal(this.src)">
                    {% if post.images|length > 1 %}
                        <div style="position: absolute; bottom: 10px; right: 10px; 
                                    background: rgba(0,0,0,0.7); color: white; 
                                    padding: 0.3rem 0.6rem; border-radius: 15px; font-size: 0.8rem;">
                            +{{ post.images|length - 1 }} å¼ 
                        </div>
                    {% endif %}
                {% else %}
                    <div style="display: flex; align-items: center; justify-content: center; 
                                height: 100%; background-color: #f8f9fa; color: #999;">
                        <div style="text-align: center;">
                            <div style="font-size: 3rem;">ğŸ¾</div>
                            <div>æš‚æ— å›¾ç‰‡</div>
                        </div>
                    </div>
                {% endif %}
            </div>
            
            <!-- å†…å®¹åŒºåŸŸ -->
            <div class="post-content">
                <div class="post-title">
                    <a href="{{ url_for('view_post', post_id=post.id) }}" 
                       style="text-decoration: none; color: inherit;">
                        {{ post.title }}
                    </a>
                </div>
                
                <div class="post-meta">
                    <span>ğŸ·ï¸ {{ post.pet_type }}</span>
                    <span style="margin-left: 1rem;">ğŸ“ {{ post.lost_location }}</span>
                </div>
                
                <div class="post-description">
                    {{ post.description }}
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; 
                            margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
                    <div style="color: #7f8c8d; font-size: 0.9rem;">
                        <span>ğŸ‘¤ {{ post.author.username }}</span>
                        <span style="margin-left: 1rem;">ğŸ•’ {{ post.created_at.strftime('%m-%d %H:%M') }}</span>
                    </div>
                    <div style="color: #7f8c8d; font-size: 0.9rem;">
                        ğŸ’¬ {{ post.comments|length }} æ¡è¯„è®º
                    </div>
                </div>
                
                <a href="{{ url_for('view_post', post_id=post.id) }}" 
                   class="btn btn-primary" style="width: 100%; margin-top: 1rem;">
                    æŸ¥çœ‹è¯¦æƒ…
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="card" style="text-align: center; padding: 3rem;">
        <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ¾</div>
        <h3 style="color: #7f8c8d; margin-bottom: 1rem;">æš‚æ— å¯»å® ä¿¡æ¯</h3>
        <p style="color: #999; margin-bottom: 2rem;">æˆä¸ºç¬¬ä¸€ä¸ªå‘å¸ƒå¯»å® ä¿¡æ¯çš„ç”¨æˆ·å§ï¼</p>
        {% if current_user.is_authenticated %}
            <a href="{{ url_for('create_post') }}" class="btn btn-primary">
                å‘å¸ƒç¬¬ä¸€æ¡ä¿¡æ¯
            </a>
        {% else %}
            <a href="{{ url_for('register') }}" class="btn btn-primary">
                æ³¨å†Œå¹¶å‘å¸ƒ
            </a>
        {% endif %}
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// æœç´¢å’Œç­›é€‰åŠŸèƒ½
function setupSearchAndFilter() {
    const searchInput = document.getElementById('search-input');
    const petTypeFilter = document.getElementById('pet-type-filter');
    const posts = document.querySelectorAll('.post-card');
    
    function filterPosts() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedType = petTypeFilter.value;
        
        posts.forEach(post => {
            const title = post.querySelector('.post-title').textContent.toLowerCase();
            const description = post.querySelector('.post-description').textContent.toLowerCase();
            const location = post.querySelector('.post-meta').textContent.toLowerCase();
            const petType = post.dataset.petType;
            
            const matchesSearch = !searchTerm || 
                                title.includes(searchTerm) || 
                                description.includes(searchTerm) || 
                                location.includes(searchTerm);
            
            const matchesType = !selectedType || petType === selectedType;
            
            if (matchesSearch && matchesType) {
                post.style.display = 'block';
            } else {
                post.style.display = 'none';
            }
        });
    }
    
    searchInput.addEventListener('input', filterPosts);
    petTypeFilter.addEventListener('change', filterPosts);
}

// å›¾ç‰‡æ¨¡æ€æ¡†
function openImageModal(src) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="closeModal(this)">
            <div class="modal-content">
                <img src="${src}" alt="å® ç‰©å›¾ç‰‡">
                <button class="close-btn" onclick="closeModal(this)">&times;</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    setupSearchAndFilter();
});
</script>
{% endblock %}