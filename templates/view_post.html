{% extends "base.html" %}

{% block title %}{{ post.title }} - å® ç‰©ä¸¢å¤±ç½‘ç«™{% endblock %}

{% block content %}
<!-- è¿”å›æŒ‰é’® -->
<div style="margin-bottom: 1rem;">
    <a href="{{ url_for('index') }}" class="btn" style="background-color: #95a5a6; color: white;">
        â† è¿”å›é¦–é¡µ
    </a>
</div>

<!-- å¸–å­è¯¦æƒ… -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-body">
        <!-- æ ‡é¢˜å’ŒåŸºæœ¬ä¿¡æ¯ -->
        <div style="border-bottom: 1px solid #eee; padding-bottom: 1rem; margin-bottom: 1.5rem;">
            <h1 style="color: #2c3e50; margin-bottom: 1rem;">{{ post.title }}</h1>
            <div style="display: flex; flex-wrap: wrap; gap: 1rem; color: #7f8c8d;">
                <span>ğŸ·ï¸ {{ post.pet_type }}</span>
                <span>ğŸ“ {{ post.lost_location }}</span>
                <span>ğŸ‘¤ {{ post.author.username }}</span>
                <span>ğŸ•’ {{ post.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}</span>
            </div>
        </div>
        
        <!-- å›¾ç‰‡å±•ç¤º -->
        {% if post.images %}
        <div style="margin-bottom: 2rem;">
            <h3 style="color: #2c3e50; margin-bottom: 1rem;">ğŸ“· å® ç‰©ç…§ç‰‡</h3>
            <div class="image-grid">
                {% for image in post.images %}
                <div class="image-item">
                    <img src="{{ url_for('static', filename='uploads/' + image.filename) }}" 
                         alt="å® ç‰©ç…§ç‰‡" onclick="openImageModal(this.src)" 
                         style="cursor: pointer;">
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        
        <!-- è¯¦ç»†æè¿° -->
        <div style="margin-bottom: 2rem;">
            <h3 style="color: #2c3e50; margin-bottom: 1rem;">ğŸ“ è¯¦ç»†æè¿°</h3>
            <div style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 8px; 
                        line-height: 1.8; white-space: pre-wrap;">{{ post.description }}</div>
        </div>
        
        <!-- è”ç³»æ–¹å¼ -->
        <div style="background-color: #e8f5e8; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
            <h3 style="color: #27ae60; margin-bottom: 1rem;">ğŸ“ è”ç³»æ–¹å¼</h3>
            <p style="font-size: 1.1rem; margin: 0; color: #2c3e50;">{{ post.contact_info }}</p>
            <small style="color: #666;">å¦‚æœæ‚¨æœ‰ç›¸å…³çº¿ç´¢ï¼Œè¯·é€šè¿‡ä»¥ä¸Šæ–¹å¼è”ç³»å¤±ä¸»</small>
        </div>
        
        <!-- æ“ä½œæŒ‰é’® -->
        {% if current_user.is_authenticated and current_user.id == post.user_id %}
        <div style="text-align: right; padding-top: 1rem; border-top: 1px solid #eee;">
            <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" 
                  style="display: inline;" 
                  onsubmit="return confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¯»å® ä¿¡æ¯å—ï¼Ÿ')">
                <button type="submit" class="btn btn-danger">
                    ğŸ—‘ï¸ åˆ é™¤å¸–å­
                </button>
            </form>
        </div>
        {% endif %}
    </div>
</div>

<!-- è¯„è®ºåŒº -->
<div class="card">
    <div class="card-header">
        <h3 style="margin: 0;">ğŸ’¬ è¯„è®ºåŒº ({{ comments|length }})</h3>
    </div>
    <div class="card-body">
        <!-- å‘è¡¨è¯„è®º -->
        {% if current_user.is_authenticated %}
        <div style="background-color: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">å‘è¡¨è¯„è®º</h4>
            <form class="comment-form" data-post-id="{{ post.id }}" onsubmit="submitComment(event)">
                <div class="form-group">
                    <textarea class="form-control" name="content" required 
                              placeholder="å¦‚æœæ‚¨æœ‰ç›¸å…³çº¿ç´¢æˆ–æƒ³è¦æä¾›å¸®åŠ©ï¼Œè¯·åœ¨è¿™é‡Œç•™è¨€..." 
                              rows="3" maxlength="1000"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="comment_images">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼Œæœ€å¤š3å¼ ï¼‰</label>
                    <input type="file" id="comment_images" name="comment_images" 
                           multiple accept="image/*" class="form-control">
                </div>
                
                <button type="submit" class="btn btn-primary">
                    å‘è¡¨è¯„è®º
                </button>
            </form>
        </div>
        {% else %}
        <div style="text-align: center; padding: 2rem; background-color: #f8f9fa; 
                    border-radius: 8px; margin-bottom: 2rem;">
            <p style="margin-bottom: 1rem; color: #666;">è¯·ç™»å½•åå‘è¡¨è¯„è®º</p>
            <a href="{{ url_for('login') }}" class="btn btn-primary">ç«‹å³ç™»å½•</a>
        </div>
        {% endif %}
        
        <!-- è¯„è®ºåˆ—è¡¨ -->
        {% if comments %}
        <div class="comments-list">
            {% for comment in comments %}
            <div class="comment">
                <div class="comment-header">
                    <span class="comment-author">{{ comment.author.username }}</span>
                    <span class="comment-date">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    {% if current_user.is_authenticated and (comment.user_id == current_user.id or post.user_id == current_user.id) %}
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteComment({{ comment.id }})" 
                            style="margin-left: auto; padding: 0.2rem 0.5rem; font-size: 0.8rem;">
                        åˆ é™¤
                    </button>
                    {% endif %}
                </div>
                
                <div class="comment-content" style="margin: 0.5rem 0;">
                    {{ comment.content }}
                </div>
                
                <!-- è¯„è®ºå›¾ç‰‡ -->
                {% if comment.images %}
                <div class="comment-images" style="margin-top: 1rem;">
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        {% for image in comment.images %}
                        <img src="{{ url_for('static', filename='uploads/' + image.filename) }}" 
                             alt="è¯„è®ºå›¾ç‰‡" 
                             style="width: 100px; height: 100px; object-fit: cover; 
                                    border-radius: 8px; cursor: pointer;" 
                             onclick="openImageModal(this.src)">
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="text-align: center; padding: 2rem; color: #999;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ’­</div>
            <p>æš‚æ— è¯„è®ºï¼Œæˆä¸ºç¬¬ä¸€ä¸ªè¯„è®ºçš„äººå§ï¼</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// æäº¤è¯„è®º
function submitComment(event) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const postId = form.dataset.postId;
    
    // æ£€æŸ¥è¯„è®ºå†…å®¹
    const content = formData.get('content').trim();
    if (!content) {
        showAlert('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'danger');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    submitBtn.textContent = 'å‘å¸ƒä¸­...';
    submitBtn.disabled = true;
    
    fetch(`/add_comment/${postId}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('è¯„è®ºå‘å¸ƒæˆåŠŸï¼', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showAlert(data.message || 'è¯„è®ºå‘å¸ƒå¤±è´¥', 'danger');
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'danger');
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
    });
}

// åˆ é™¤è¯„è®º
function deleteComment(commentId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
    }
    
    fetch(`/delete_comment/${commentId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('è¯„è®ºå·²åˆ é™¤', 'success');
            setTimeout(() => {
                location.reload();
            }, 1000);
        } else {
            showAlert(data.message || 'åˆ é™¤å¤±è´¥', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', 'danger');
    });
}

// å›¾ç‰‡æ¨¡æ€æ¡†
function openImageModal(src) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `
        <div class="modal-backdrop" onclick="closeModal(this)">
            <div class="modal-content">
                <img src="${src}" alt="å›¾ç‰‡">
                <button class="close-btn" onclick="closeModal(this)">&times;</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    document.body.style.overflow = 'hidden';
}

// å…³é—­æ¨¡æ€æ¡†
function closeModal(element) {
    const modal = element.closest('.image-modal');
    if (modal) {
        modal.remove();
        document.body.style.overflow = 'auto';
    }
}
</script>
{% endblock %}